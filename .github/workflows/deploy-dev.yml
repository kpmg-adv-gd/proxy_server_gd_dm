name: Deploy to Dev (Cloud Foundry)

on:
  push:
    branches:
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: CI-CD-DEV

    steps:
      - name: ğŸ”„ Checkout codice
        uses: actions/checkout@v4

      - name: ğŸ§ª Installa dipendenze e lancia i test
        run: |
          echo "ğŸ“¦ Installo dipendenze..."
          npm install
          echo "ğŸ§ª Eseguo test unitari..."
          npm test

      - name: Usa manifest per ambiente Dev
        run: cp .staging/manifest-dev.yml manifest.yml


      - name: ğŸ”§ Installa cf CLI via dpkg
        run: |
          echo "ğŸ“¦ Scarico pacchetto Debian cf CLI..."
          curl -L "https://packages.cloudfoundry.org/stable?release=debian64" -o cf.deb
          sudo dpkg -i cf.deb
          cf version

      - name: ğŸ” Login su Cloud Foundry
        run: |
          set -e
          echo "ğŸŒ API endpoint: ${{ vars.CF_API }}"
          echo "ğŸ‘¤ Login con utente: ${{ vars.CF_USERNAME }}"
          cf login -a '${{ vars.CF_API }}' -u '${{ vars.CF_USERNAME }}' -p '${{ secrets.CF_PASSWORD }}' -o '${{ vars.CF_ORG }}' -s '${{ vars.CF_SPACE_DEV }}'

      - name: ğŸš€ Deploy su ambiente Dev
        run: |
          set -e
          echo "ğŸ“‚ Lista file in workspace:"
          ls -la
          echo "ğŸ“¦ Avvio cf push..."
          cf push --var ENV=dev